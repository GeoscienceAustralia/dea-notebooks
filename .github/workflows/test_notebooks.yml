
name: Test notebooks

on:
  push:
    branches: [ develop, stable, nbtests ]
  pull_request:
    branches: [ develop, stable ]
jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: geoscienceaustralia/sandbox:latest
      options: --user root

    env:
      DB_HOSTNAME: postgres
      DB_USERNAME: postgres
      DB_PASSWORD: opendatacubepassword
      DB_DATABASE: postgres
      AWS_DEFAULT_REGION: ap-southeast-2
      AWS_ACCESS_KEY_ID: fake_id
      AWS_SECRET_ACCESS_KEY: fake_key
      AWS_NO_SIGN_REQUEST: YES

    steps:
    - uses: actions/checkout@v2
    - name: Install Docker
      run: |
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
        docker-compose --version
    - name: Set up Datacube
      run: |
        docker-compose up -d
        datacube product list
    - name: Test with pytest
      run: |
        pytest --nbval-lax Beginners_guide/01*
