
name: Test notebooks

on:
  push:
    branches: [ develop, stable, nbtests ]
  pull_request:
    branches: [ develop, stable ]
jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: geoscienceaustralia/sandbox:latest
      options: --user root
    
    services:
      index:
        image: opendatacube/datacube-index:0.0.13
        env:
          DB_HOSTNAME: postgres
          DB_USERNAME: postgres
          DB_PASSWORD: opendatacubepassword
          DB_DATABASE: postgres
          DB_PORT: 5432
          AWS_DEFAULT_REGION: ap-southeast-2
      
      postgres:
        image: postgres:11.5-alpine
        ports:
          - 5432:5434
        env:
          POSTGRES_PASSWORD: opendatacubepassword
          POSTGRES_USERNAME: postgres
          POSTGRES_DB: postgres

    env:
      DB_HOSTNAME: postgres
      DB_USERNAME: postgres
      DB_PASSWORD: opendatacubepassword
      DB_DATABASE: postgres
      AWS_DEFAULT_REGION: ap-southeast-2
      AWS_ACCESS_KEY_ID: fake_id
      AWS_SECRET_ACCESS_KEY: fake_key
      AWS_NO_SIGN_REQUEST: YES

    steps:
    - uses: actions/checkout@v2
    - name: Set up Datacube
      run: |
        bash Tests/setup_test_datacube.sh
        datacube products list
    - name: Test with pytest
      run: |
        pytest Tests
